version: '3.8'

services:
  # Authentication Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: rednest-auth-service
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      NODE_ENV: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      JWT_SECRET: ${JWT_SECRET:-Yu3UjJv4/iUH4ykcI6q9aA==}
      JWT_EXPIRES_IN: 24h
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-vY680jpsBB5IyPC2YEKUVw==}
      JWT_REFRESH_EXPIRES_IN: 7d
      CORS_ORIGIN: http://localhost:3000
    networks:
      - rednest-network
    restart: unless-stopped

  # Traveler Service
  traveler-service:
    build:
      context: ./services/traveler-service
      dockerfile: Dockerfile
    container_name: rednest-traveler-service
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      NODE_ENV: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      JWT_SECRET: ${JWT_SECRET:-Yu3UjJv4/iUH4ykcI6q9aA==}
      BOOKING_SERVICE_URL: http://booking-service:3005
      PROPERTY_SERVICE_URL: http://property-service:3004
      KAFKA_BROKERS: kafka:9092
      CORS_ORIGIN: http://localhost:3000
    volumes:
      - traveler-uploads:/app/uploads
    depends_on:
      - auth-service
      - kafka
    networks:
      - rednest-network
    restart: unless-stopped

  # Owner Service
  owner-service:
    build:
      context: ./services/owner-service
      dockerfile: Dockerfile
    container_name: rednest-owner-service
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      NODE_ENV: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      JWT_SECRET: ${JWT_SECRET:-Yu3UjJv4/iUH4ykcI6q9aA==}
      BOOKING_SERVICE_URL: http://booking-service:3005
      PROPERTY_SERVICE_URL: http://property-service:3004
      KAFKA_BROKERS: kafka:9092
      CORS_ORIGIN: http://localhost:3000
    volumes:
      - owner-uploads:/app/uploads
    depends_on:
      - auth-service
      - kafka
    networks:
      - rednest-network
    restart: unless-stopped

  # Property Service
  property-service:
    build:
      context: ./services/property-service
      dockerfile: Dockerfile
    container_name: rednest-property-service
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      NODE_ENV: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      JWT_SECRET: ${JWT_SECRET:-Yu3UjJv4/iUH4ykcI6q9aA==}
      KAFKA_BROKERS: kafka:9092
      CORS_ORIGIN: http://localhost:3000
    volumes:
      - property-uploads:/app/uploads
    depends_on:
      - auth-service
      - kafka
    networks:
      - rednest-network
    restart: unless-stopped

  # Booking Service
  booking-service:
    build:
      context: ./services/booking-service
      dockerfile: Dockerfile
    container_name: rednest-booking-service
    ports:
      - "3005:3005"
    environment:
      PORT: 3005
      NODE_ENV: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      JWT_SECRET: ${JWT_SECRET:-Yu3UjJv4/iUH4ykcI6q9aA==}
      PROPERTY_SERVICE_URL: http://property-service:3004
      KAFKA_BROKERS: kafka:9092
      CORS_ORIGIN: http://localhost:3000
    depends_on:
      - auth-service
      - property-service
      - kafka
    networks:
      - rednest-network
    restart: unless-stopped

  # Zookeeper (for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: rednest-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - rednest-network
    restart: unless-stopped

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: rednest-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_INTERNAL://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    networks:
      - rednest-network
    restart: unless-stopped

  # AI Agent Service (TripMate)
  ai-agent-service:
    build:
      context: ./services/ai-agent-service
      dockerfile: Dockerfile
    container_name: rednest-ai-agent-service
    ports:
      - "3006:3006"
    environment:
      PORT: 3006
      ENVIRONMENT: development
      MONGODB_URI: mongodb+srv://dygandole_db_user:dygandole_db_pass@rednest.yv8hxk8.mongodb.net/rednest?appName=Rednest&retryWrites=true&w=majority
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      BOOKING_SERVICE_URL: http://booking-service:3005
      PROPERTY_SERVICE_URL: http://property-service:3004
      TRAVELER_SERVICE_URL: http://traveler-service:3002
      CORS_ORIGIN: http://localhost:3000
    depends_on:
      - booking-service
      - property-service
    networks:
      - rednest-network
    restart: unless-stopped

volumes:
  traveler-uploads:
    driver: local
  owner-uploads:
    driver: local
  property-uploads:
    driver: local

networks:
  rednest-network:
    driver: bridge

